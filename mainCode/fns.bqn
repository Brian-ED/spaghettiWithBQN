_While_ â‡{ğ”½âŸğ”¾âˆ˜ğ”½_ğ•£_ğ”¾âˆ˜ğ”½âŸğ”¾ğ•©}
Print â‡âŠ¢âŠ£  (â€¢pathâˆ¾"/out.txt") â€¢FChars â€¢Repr
IsString â‡(1==)â—¶âŸ¨0â‹„âˆ§Â´2=â€¢TypeÂ¨âŸ©
ToPyTuple â‡{Â«âˆ¾1âŒ½Â¨""","""âŠ¸âˆ¾âŸœâˆ¾Â¨"\"""âŠ¸(âŠ‘âŠ)â—¶"\\"â€¿"\"""â€¿â¥ŠÂ¨Â¨ğ•©}
Split â‡(âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢

NN â† (>âŸœÂ«0âŠ¸â‰¤) / 0(0âŠ¸â‰¤Ã—Ã—âŸœ10âŠ¸+)`âŠ¢
# General numbers recognize digits and eE.Â¯-Ï€âˆ (mild extension of BQN) by Marshall

ReplaceAll â‡ { âŸ¨old,newâŸ© ğ•Š str:
  !newâ‰ âŠ¸â‰¡lâ†â‰ old
  "ReplaceAll: Can't replace empty" ! âˆ§Â´0<â‰ Â¨old
  match â† 1-Ëœ (l+1)|âŒŠÂ´ (â†•âŠ¸-l) Ã— old (1<â‰ âˆ˜âŠ£)â—¶âŸ¨âŠ‘âŠ¸=,â‰ âˆ˜âŠ¢â†‘â·âŸ©Â¨ <str
  cont â† (-âŸœ1âŒˆâ‰¤âŸœ1Ã—âŠ¢)` match âŠ (â‰ Â¨old)âˆ¾0
  keep â† â‹ˆâŸœ(âŠâŸœstr) / 0=cont
  insert â† (newâŠËœâŠâŸœmatch)âŠ¸(â‰ Â¨âŠ¸/â‹ˆâˆ¾âˆ˜âŠ£) / (0âŠ¸<âˆ§Â»âŠ¸â‰¤) cont
  â‹âŠ¸âŠÂ´ keep âˆ¾Â¨ insert
}

# Modified ToNums from Marshals string lib.
# Now works on True, False, and nans from python
ToNums â‡ ({
  Tâ†âŒˆ`Ã— â‹„ I1Tâ†(1+â†•âˆ˜â‰ )âŠ¸T
  cdâ†â‰ digâ†"Ï€âˆN"âˆ¾Ëœ'0'+â†•10 â‹„ valâ†Ï€â€¿1â€¿1â€¿Â¯1âˆ¾Ëœâ†•10 # âˆ as 1 to avoid âˆÃ—0
  eâ€¿dâ€¿nâ€¿pâ€¿iâ€¿nanâ†"e.Â¯Ï€âˆN"=<ğ•© â‹„ eâ€¿nâˆ¨â†©"E-"=<ğ•©
  mâ†dâˆ¨cd>jâ†digâŠğ•©
  sâ†dâˆ¨câ†eâˆ¨zâ†(âˆ§`âŒ¾âŒ½<Â»âŠ¸<)zzâ†Â¬eâˆ¨nâˆ¨m
  "dubble spaces dissalowed"!Â¬âˆ¨Â´"  "â·ğ•©
  "Negative sign in the middle of a number"! âˆ§Â´nâ‰¤1Â»c
  "Portion of a number is empty"! âˆ§Â´Â¬(1Â«s)âˆ§nâˆ¨s
  "Ill-formed decimal or exponent use"! âˆ§Â´(0âŠ¸=âˆ¨Â»âŠ¸<)s/d+2Ã—e
  "Ï€ and âˆ must occur alone"! âˆ§Â´(pâˆ¨i)â‰¤1(Â»âˆ§(pâˆ§Â«e)âˆ¨Â«)zzâˆ¨n>Â»e
  fâ†(17â‰¥Â¬(âŠ¢-T)+`)âŠ¸âˆ§gâ†(Â«â‰¤(d<jâ‰ 0)>â—‹I1TÂ¬)âŠ¸âˆ§m   # No leading 0s; max 17 digits
  vsâ†1â€¿Â¯1âŠËœ(râ†>âŸœÂ»m)/Â»n                      # Negate if Â¯
  vâ†vsÃ—NN valâŠËœdÂ¬âŠ¸/jâŒˆcdÃ—Â¬f                  # Numeric valuesâ€”mantissas and exponents
  vmâ†c/â—‹(1âŒ¾âŠ‘)z                              # Mask of mantissas in v
  dpâ†vm/f(--Â»âŠ¸-(<Ã—âŠ¢)âŠâŸœ(I1TÂ«d)âŠ¸-)â—‹(/>âŸœÂ«)g    # Decimal position
  qâ†10â‹†|eeâ†dp-Ëœvm/Â«vÃ—Â¬vm                    # Power of 10
  qÃ·ËœâŒ¾((0>ee)âŠ¸/)qÃ—âŒ¾((0<ee)âŠ¸/)vm/vÃ—âŸ¨1,âˆ,0Ã·0âŸ©âŠËœâŒˆÂ´(1+â†•âˆ˜â‰ )âŠ¸Ã—râŠ¸/Â¨iâ€¿nan # Correct âˆ then Ã—10â‹†ee
}âŸ¨"True"â€¿"False"â€¿"inf"â€¿"nan"
  "1"   â€¿"0"    â€¿"âˆ"  â€¿"N"
âŸ©ReplaceAllâŠ¢)âŸ(âŸ¨âŸ©âŠ¸â‰¢)

# TODO add .run so you can use python function in bqn
PyFunc â‡{
  ğ•ŠfuncName:
  !IsString ğ•©
  "applyPyFunc" comm.SendMsg funcNameâŠ¸â‹ˆ
}

ExtractTypes â†{
  IsString ğ•©? 's';
  0=â€¢Typeğ•©?
    âˆ¾Â´("l"âŠ¸âˆ¾âŸ(0=â‰ )'l'Â»Â«""âˆ¾Â´' 'âˆ¾Â¨â€¢ReprÂ¨â‰¢ğ•©)âˆ¾âˆ¾Â´ğ•ŠÂ¨â¥Šğ•©;
  6=â€¢Typeğ•©?'F';
  "ncf"âŠ‘Ëœ2âŒŠÂ¯1+â€¢Type ğ•©
}

Crunchâ†{
  xâ†âŸ¨âŸ©
  IsStringâ—¶{
    xâˆ¾â†©âˆ¾âˆ˜("Â¯âˆN"âŠ¸(âŠ‘âŠ)â—¶"-"â€¿"inf"â€¿"n"â€¿â¥ŠÂ¨â€¢Repr)âŸ(2â‰ â€¢Type)Â¨â¥Šğ•©
  }â€¿{
    xâˆ¾â†©<ğ•©
  }âš‡1ğ•©
  x
}

IntoMediary â‡{
  ğ•Š: (ExtractTypes <âŠ¸âˆ¾ Crunch) ğ•©;
  ğ•Šâ¼:
    types â†âŠ‘ğ•©
    args â†1â†“ğ•©
    
    typesInShapeâ†âŠ‘PrintâŸ¨âŸ©â‰¡âŸœ'l'â—¶âŸ¨
      âˆ¾Ëœ
      {-+Â´ğ•©âˆŠ' 'âˆ¾'0'+â†•10}(ToNumsâˆ˜â†‘(Ã—Â´âŠ¸â†“ âŒ½âŠ¸âˆ¾ <âˆ˜â¥Š)âŒ½âˆ˜â†“)âŠ¢
    âŸ©Â´types

    args GroupTypes typesInShape
}

GroupTypesâ†{argsğ•ŠtypesInShape:
  xâ†ğ•¨
  Fâ†{ğ•Š:(xâŒ½Ëœâ†©1)âŠ¢âŠ‘x}
  {(F@){ğ•ğ•¨}(âŠ‘ToNums)â€¿âŠ¢â€¿âŠ‘â€¿â€¢BQNâ€¿ PyFuncâŠ‘ËœâŠ‘"nscfF"âŠğ•©}âš‡0 ğ•©
}

commâ‡{
  âŸ¨commPath
  SetID
  
  âŸ©â‡
  commPathâ‡"comm/Default"
  
  â€¢file.Existsâ—¶âŸ¨
    â€¢file.CreateDir
    â€¢file.RemoveÂ¨<âˆ˜âˆ¾âŸœ'/'âˆ¾Â¨â€¢file.List
  âŸ©commPath

  SetIDâ‡{
    "Only strings as name of communication allowed"!IsStringğ•©
    (âˆ§Â´ğ•©âˆŠ"_"âˆ¾â¥Š"aA"+âŒœâ†•26)!Ëœ"only alphabetical characters and spaces as name of communication allowed"
    commPathâ†"comm/"âˆ¾ğ•©
  }

  MsgExistsâ‡{ğ•Š:"TODO"}

  actionsâ†âŸ¨"applyPyFunc"âŸ©

  SendMsg â‡ {
    ğ•Šâ¼:GetMsg 1;
    pathâ†{ğ•©âˆ¾'/'âˆ¾(ğ•¨âŠ£"msgFromBQN")âˆ¾".txt"âˆ¾Ëœâ€¢Reprâ‰ â€¢file.Listğ•©}commPath
    "That action doesn't exist"!âˆ¨Â´ğ•¨âˆŠactions
    path â€¢FChars ToPyTuple IntoMediary ğ•©
  }

  noMsgErrorâ†"No msg found. Please âŠ if expected, or 'GetMsg 1' to wait for msg"
  GetMsg â‡{
    waitâ†1â‰¡ğ•©
    FindFileâ†"msgFromPy"âŠ¸(âŠ£â‰¡â‰ âŠ¸â†‘)Â¨â€¢file.List
    mâ†FindFile _while_{â€¢Delay 0.2â‹„Â¬âˆ¨Â´ğ•©}âŸwait FindFile commPath
    noMsgError!âˆ¨Â´m
    fileâ†âŠ‘âˆ§m/â€¢file.List commPath
    (â€¢file.RemoveâŠ¢IntoMediaryâ¼âˆ˜â€¢FChars) file
  }
}

{ğ•Š:
â€¢Show IntoMediary â€¢Show IntoMediaryâ¼ âŸ¨"l3l4 3ccccccccccccl2 3nnnnnnl5ccl3sl2nnnnl3ccc","t","h","i","s","i","s"," ","a","t","e","s","t","nan","inf","-inf","4","5","6","a","b","nested","3","2","1","2","s",'u','m'âŸ©
}âŸ0@ #testing on or off